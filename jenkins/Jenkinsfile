pipeline {
	agent any

	options {
		skipDefaultCheckout(true)
		timestamps()
		disableConcurrentBuilds()   // ‚õî avoid overlapping docker compose runs
		timeout(time: 30, unit: 'MINUTES')   // ‚õî absolute safety net
	}

	environment {
		REGISTRY = "local"
		COMPOSE_DIR = "ims-infra/docker"
		ANGULAR_DIST = "ims-infra/docker/angular-dist"
	}

	tools {
		jdk 'jdk21'
		maven 'maven3'
		nodejs 'node20'
	}

	stages {

        stage('Pre-flight Safety Checks') {
                    steps {
                        sh '''
                            echo "===== Pre-flight checks ====="

                            echo "1Ô∏è‚É£ Checking Docker availability"
                            docker version || { echo "‚ùå Docker not running"; exit 1; }

                            echo "2Ô∏è‚É£ Checking docker compose"
                            docker compose version || { echo "‚ùå docker compose not available"; exit 1; }

                            echo "3Ô∏è‚É£ Checking Node / Maven / Java"
                            node -v
                            npm -v
                            mvn -v
                            java -version

                            echo "4Ô∏è‚É£ Checking for port conflicts"
                            for p in 8080 8081 8082 8083 8090 8095; do
                              if ss -lnt | grep -q ":$p "; then
                                echo "‚ùå Port $p already in use. Stop local apps first."
                                exit 1
                              fi
                            done

                            echo "‚úÖ Pre-flight checks passed"
                        '''
                    }
                }

		stage('Prepare Workspace') {
			steps {
				deleteDir()
			}
		}

		/* stage('DEBUG: Shell Test') {
			steps {
				sh '''
				  set -x
				  echo "Shell is working"
				  which sh
				  which bash || true
				  ls -l /bin || true
				'''
			}
		} */


		stage('Checkout Repositories') {
			steps {
				withCredentials([usernamePassword(
					credentialsId: '392e1f66-aafc-4712-a4be-876533b9f267',
					usernameVariable: 'GIT_USER',
					passwordVariable: 'GIT_TOKEN'
				)]) {
					sh '''
        set -e

        echo "Git user is: $GIT_USER"

        git clone https://${GIT_USER}:${GIT_TOKEN}@github.com/brahma1085/ims-infra.git
        git clone https://${GIT_USER}:${GIT_TOKEN}@github.com/brahma1085/ims-angular-ui.git
        git clone https://${GIT_USER}:${GIT_TOKEN}@github.com/brahma1085/ims-gateway-service.git
        git clone https://${GIT_USER}:${GIT_TOKEN}@github.com/brahma1085/ims-inventory-service.git
        git clone https://${GIT_USER}:${GIT_TOKEN}@github.com/brahma1085/ims-customer-service.git
        git clone https://${GIT_USER}:${GIT_TOKEN}@github.com/brahma1085/ims-order-service.git
      '''
				}
			}
		}




		/*stage('Build Angular UI') {
			steps {
				dir('ims-angular-ui') {
					sh '''
        npm install
        npm run build
      '''
				}
			}
		}*/

		stage('Build Angular UI') {
			steps {
			  timeout(time: 20, unit: 'MINUTES') {   // ‚õî Angular hang protection
				dir('ims-angular-ui') {
					sh '''
					set -e
					 echo "üîç Enforcing Node 20"
                        export PATH="$NODEJS_HOME/bin:$PATH"

                        node -v
                        npm -v

                        if ! node -v | grep -q "v20"; then
                          echo "‚ùå Node 20 not active. Aborting."
                          exit 1
                        fi
              export NODE_OPTIONS="--max-old-space-size=1536"
              npm install --no-audit --no-fund
              npm run build -- --configuration=production
            '''
        }
        }
        sh '''
        echo "Preparing Angular dist for Docker deployment"'
          rm -rf ${ANGULAR_DIST}
          mkdir -p ${ANGULAR_DIST}
          cp -r ims-angular-ui/dist/** ${ANGULAR_DIST}/
        '''
    }
}



		stage('Build Spring Boot Services') {
			parallel {
				stage('Gateway') {
					steps {
						dir('ims-gateway-service') {
							sh 'mvn clean package -DskipTests'
						}
					}
				}
				stage('Inventory') {
					steps {
						dir('ims-inventory-service') {
							sh 'mvn clean package -DskipTests'
						}
					}
				}
				stage('Customers') {
					steps {
						dir('ims-customer-service') {
							sh 'mvn clean package -DskipTests'
						}
					}
				}
				stage('Orders') {
					steps {
						dir('ims-order-service') {
							sh 'mvn clean package -DskipTests'
						}
					}
				}
			}
		}

		stage('Docker Build Images') {
			steps {
				sh '''
      docker build -t gateway-service ./ims-gateway-service
      docker build -t inventory-service ./ims-inventory-service
      docker build -t customers-service ./ims-customer-service
      docker build -t orders-service ./ims-order-service
    '''
			}
		}


		stage('Deploy via Docker Compose') {
                    steps {
                        dir("${COMPOSE_DIR}") {
                            sh '''
                                echo "Stopping old stack (if any)"
                                docker compose down || true

                                echo "Starting new stack"
                                docker compose up -d
                            '''
                        }
                    }
                }
	}

	post {
		success {
			echo "‚úÖ IMS deployed successfully"
			echo "‚û° UI: http://localhost:8090"
            echo "‚û° Keycloak: http://localhost:8095"
		}
		failure {
			echo "‚ùå Build failed"
		}
	}
}
